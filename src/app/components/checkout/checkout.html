<div class="modal-backdrop" *ngIf="isOpen" (click)="onBackdropClick($event)">
  <div class="modal-container">
    <!-- Botón cerrar -->
    <button class="btn-close" (click)="cerrar()" aria-label="Cerrar">
      <i class="fas fa-times"></i>
    </button>

<div class="container my-5">
  <h2 class="section-title">🛒 Finalizar Compra</h2>

  <div class="row">
    <!-- Formulario de Checkout -->
    <div class="col-lg-8">
      <!-- Datos Personales -->
      <div class="mb-5">
        <h4 class="checkout-section-title">Datos Personales</h4>
        <div class="row">
         <div class="col-md-6 mb-3">
  <label class="form-label">Nombre Completo <span class="text-danger">*</span></label>
  <input type="text" 
         class="form-control" 
         #nombre="ngModel"
         [(ngModel)]="checkoutState.datosPersonales.nombre"
         (ngModelChange)="actualizarDatosPersonales('nombre', $event)"
         required
         minlength="3"
         [class.is-invalid]="nombre.invalid && nombre.touched">
  <div class="invalid-feedback" *ngIf="nombre.invalid && nombre.touched">
    <div *ngIf="nombre.errors?.['required']">El nombre es requerido</div>
    <div *ngIf="nombre.errors?.['minlength']">El nombre debe tener al menos 3 caracteres</div>
  </div>
</div>

<div class="col-md-6 mb-3">
  <label class="form-label">RUT <span class="text-danger">*</span></label>
  <input type="text" 
         class="form-control" 
         #rut="ngModel"
         [(ngModel)]="checkoutState.datosPersonales.rut"
         (ngModelChange)="actualizarDatosPersonales('rut', $event)"
         (blur)="validarCampo('rut')"
         placeholder="12.345.678-9"
         required
         [class.is-invalid]="erroresValidacion['rut']">
  <div class="invalid-feedback" *ngIf="erroresValidacion['rut']">
    {{ erroresValidacion['rut'] }}
  </div>
</div>

<div class="col-md-6 mb-3">
  <label class="form-label">Email <span class="text-danger">*</span></label>
  <input type="email" 
         class="form-control" 
         #email="ngModel"
         [(ngModel)]="checkoutState.datosPersonales.email"
         (ngModelChange)="actualizarDatosPersonales('email', $event)"
         (blur)="validarCampo('email')"
         required
         [class.is-invalid]="erroresValidacion['email']">
  <div class="invalid-feedback" *ngIf="erroresValidacion['email']">
    {{ erroresValidacion['email'] }}
  </div>
</div>

<div class="col-md-6 mb-3">
  <label class="form-label">Teléfono <span class="text-danger">*</span></label>
  <input type="tel" 
         class="form-control" 
         #telefono="ngModel"
         [(ngModel)]="checkoutState.datosPersonales.telefono"
         (ngModelChange)="actualizarDatosPersonales('telefono', $event)"
         (blur)="validarCampo('telefono')"
         required
         [class.is-invalid]="erroresValidacion['telefono']">
  <div class="invalid-feedback" *ngIf="erroresValidacion['telefono']">
    {{ erroresValidacion['telefono'] }}
  </div>
</div>
        </div>
      </div>

      <!-- Dirección de Envío -->
      <div class="mb-5">
        <h4 class="checkout-section-title">Dirección de Envío</h4>
        <div class="row">
          <div class="col-md-8 mb-3">
            <label class="form-label">Dirección</label>
            <input type="text" class="form-control" 
                   [(ngModel)]="checkoutState.direccion.direccion"
                   (ngModelChange)="actualizarDireccion('direccion', $event)">
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Código Postal</label>
            <input type="text" class="form-control" 
                   [(ngModel)]="checkoutState.direccion.codigoPostal"
                   (ngModelChange)="actualizarDireccion('codigoPostal', $event)">
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Comuna</label>
            <input type="text" class="form-control" 
                   [(ngModel)]="checkoutState.direccion.comuna"
                   (ngModelChange)="actualizarDireccion('comuna', $event)">
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Ciudad</label>
            <input type="text" class="form-control" 
                   [(ngModel)]="checkoutState.direccion.ciudad"
                   (ngModelChange)="actualizarDireccion('ciudad', $event)">
          </div>
        </div>
      </div>

      <!-- Opciones de Envío -->
      <div class="mb-5">
        <h4 class="checkout-section-title">Opciones de Envío</h4>
        <div class="row">
          <div class="col-md-6 mb-3" *ngFor="let opcion of opcionesEnvio">
            <div class="opcion-envio" 
                 [class.seleccionada]="checkoutState.opcionEnvio?.id === opcion.id"
                 (click)="seleccionarEnvio(opcion)">
              <input type="radio" 
                     [checked]="checkoutState.opcionEnvio?.id === opcion.id"
                     (change)="seleccionarEnvio(opcion)">
              <div class="d-flex align-items-center">
                <i [class]="opcion.icono" class="me-3"></i>
                <div>
                  <h6>{{ opcion.nombre }}</h6>
                  <p class="mb-1">{{ opcion.descripcion }}</p>
                  <small class="text-muted">{{ opcion.tiempo }}</small>
                </div>
                <div class="ms-auto">
                  <strong>${{ formatearPrecio(opcion.precio) }}</strong>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Cupón de Descuento -->
      <div class="mb-5">
        <h4 class="checkout-section-title">Cupón de Descuento</h4>
        <div class="row">
          <div class="col-md-8">
            <input type="text" class="form-control" 
                   [(ngModel)]="codigoCupon" 
                   placeholder="Ingresa tu código de cupón">
          </div>
          <div class="col-md-4">
            <button class="btn btn-aplicar-cupon w-100" (click)="aplicarCupon()">
              Aplicar Cupón
            </button>
          </div>
        </div>
        <div *ngIf="checkoutState.cuponAplicado" class="mt-3">
          <div class="alert alert-success d-flex justify-content-between align-items-center">
            <span>
              <i class="fas fa-check-circle me-2"></i>
              Cupón aplicado: {{ checkoutState.cuponAplicado.descripcion }}
            </span>
            <button class="btn btn-sm btn-outline-danger" (click)="removerCupon()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Resumen de Compra -->
    <div class="col-lg-4">
      <div class="resumen-card">
        <h5 class="mb-3">Resumen de Compra</h5>
        
        <!-- Items del Carrito -->
        <div *ngFor="let item of carrito" class="resumen-item">
          <div>
            <h6>{{ item.nombre }}</h6>
            <small class="text-muted">Cantidad: {{ item.cantidad }}</small>
          </div>
          <div class="text-end">
            <strong>${{ formatearPrecio(item.precio * item.cantidad) }}</strong>
          </div>
        </div>

        <!-- Subtotal -->
        <div class="resumen-item">
          <span>Subtotal</span>
          <span>${{ formatearPrecio(getTotalPrecio()) }}</span>
        </div>

        <!-- Envío -->
        <div class="resumen-item" *ngIf="checkoutState.opcionEnvio">
          <span>Envío ({{ checkoutState.opcionEnvio.nombre }})</span>
          <span>${{ formatearPrecio(checkoutState.opcionEnvio.precio) }}</span>
        </div>

        <!-- Descuento -->
        <div class="resumen-item" *ngIf="checkoutState.cuponAplicado">
          <span>Descuento</span>
          <span class="text-success">
            -${{ formatearPrecio(checkoutState.cuponAplicado.descuento) }}
          </span>
        </div>

        <!-- Total -->
        <div class="resumen-item">
          <span>Total</span>
          <span>${{ formatearPrecio(getTotalConEnvio()) }}</span>
        </div>

        <!-- Botón de Confirmación -->
      <button class="btn btn-confirmar w-100 mt-4" 
              (click)="confirmarCompra()"
              [disabled]="!formularioValido()">
        <i class="fas fa-credit-card me-2"></i>
        Confirmar Compra
      </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center py-5">
        <div class="success-icon mb-4">
          <i class="fas fa-check-circle text-success" style="font-size: 5rem;"></i>
        </div>
        <h3 class="mb-3">¡Compra Realizada con Éxito!</h3>
        <p class="text-muted mb-4">
          Tu pedido ha sido procesado correctamente.<br>
          Recibirás un email de confirmación en breve.
        </p>
        <div class="order-details bg-light p-3 rounded mb-4" *ngIf="ordenCompra">
          <p class="mb-2"><strong>Número de Orden:</strong> #{{ ordenCompra.numero }}</p>
          <p class="mb-0"><strong>Total:</strong> ${{ ordenCompra.total | number:'1.0-0' }}</p>
        </div>
        <button type="button" class="btn btn-confirmar" (click)="cerrarModalExito()">
          Entendido
        </button>
      </div>
    </div>
  </div>
</div>