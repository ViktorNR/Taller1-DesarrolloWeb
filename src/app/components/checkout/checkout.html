<div class="modal-backdrop" *ngIf="isOpen" (click)="onBackdropClick($event)">
  <div class="modal-container">
    <!-- Botón cerrar -->
    <button class="btn-close" (click)="cerrar()" aria-label="Cerrar">
      <i class="fas fa-times"></i>
    </button>

<div class="container my-5">
  <h2 class="section-title">🛒 Finalizar Compra</h2>

  <div class="row">
    <!-- Formulario de Checkout -->
    <div class="col-lg-8">
      <!-- Datos Personales -->
      <div class="mb-5">
        <h4 class="checkout-section-title">Datos Personales</h4>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Nombre Completo</label>
            <input type="text" class="form-control" 
                   [(ngModel)]="checkoutState.datosPersonales.nombre"
                   (ngModelChange)="actualizarDatosPersonales('nombre', $event)">
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" 
                   [(ngModel)]="checkoutState.datosPersonales.email"
                   (ngModelChange)="actualizarDatosPersonales('email', $event)">
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">RUT</label>
            <input type="text" class="form-control" 
                   [(ngModel)]="checkoutState.datosPersonales.rut"
                   (ngModelChange)="actualizarDatosPersonales('rut', $event)"
                   placeholder="12.345.678-9">
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Teléfono</label>
            <input type="tel" class="form-control" 
                   [(ngModel)]="checkoutState.datosPersonales.telefono"
                   (ngModelChange)="actualizarDatosPersonales('telefono', $event)">
          </div>
        </div>
      </div>

      <!-- Dirección de Envío -->
      <div class="mb-5">
        <h4 class="checkout-section-title">Dirección de Envío</h4>
        <div class="row">
          <div class="col-md-8 mb-3">
            <label class="form-label">Dirección</label>
            <input type="text" class="form-control" 
                   [(ngModel)]="checkoutState.direccion.direccion"
                   (ngModelChange)="actualizarDireccion('direccion', $event)">
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Código Postal</label>
            <input type="text" class="form-control" 
                   [(ngModel)]="checkoutState.direccion.codigoPostal"
                   (ngModelChange)="actualizarDireccion('codigoPostal', $event)">
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Comuna</label>
            <input type="text" class="form-control" 
                   [(ngModel)]="checkoutState.direccion.comuna"
                   (ngModelChange)="actualizarDireccion('comuna', $event)">
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Ciudad</label>
            <input type="text" class="form-control" 
                   [(ngModel)]="checkoutState.direccion.ciudad"
                   (ngModelChange)="actualizarDireccion('ciudad', $event)">
          </div>
        </div>
      </div>

      <!-- Opciones de Envío -->
      <div class="mb-5">
        <h4 class="checkout-section-title">Opciones de Envío</h4>
        <div class="row">
          <div class="col-md-6 mb-3" *ngFor="let opcion of opcionesEnvio">
            <div class="opcion-envio" 
                 [class.seleccionada]="checkoutState.opcionEnvio?.id === opcion.id"
                 (click)="seleccionarEnvio(opcion)">
              <input type="radio" 
                     [checked]="checkoutState.opcionEnvio?.id === opcion.id"
                     (change)="seleccionarEnvio(opcion)">
              <div class="d-flex align-items-center">
                <i [class]="opcion.icono" class="me-3"></i>
                <div>
                  <h6>{{ opcion.nombre }}</h6>
                  <p class="mb-1">{{ opcion.descripcion }}</p>
                  <small class="text-muted">{{ opcion.tiempo }}</small>
                </div>
                <div class="ms-auto">
                  <strong>${{ formatearPrecio(opcion.precio) }}</strong>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Cupón de Descuento -->
      <div class="mb-5">
        <h4 class="checkout-section-title">Cupón de Descuento</h4>
        <div class="row">
          <div class="col-md-8">
            <input type="text" class="form-control" 
                   [(ngModel)]="codigoCupon" 
                   placeholder="Ingresa tu código de cupón">
          </div>
          <div class="col-md-4">
            <button class="btn btn-aplicar-cupon w-100" (click)="aplicarCupon()">
              Aplicar Cupón
            </button>
          </div>
        </div>
        <div *ngIf="checkoutState.cuponAplicado" class="mt-3">
          <div class="alert alert-success d-flex justify-content-between align-items-center">
            <span>
              <i class="fas fa-check-circle me-2"></i>
              Cupón aplicado: {{ checkoutState.cuponAplicado.descripcion }}
            </span>
            <button class="btn btn-sm btn-outline-danger" (click)="removerCupon()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Resumen de Compra -->
    <div class="col-lg-4">
      <div class="resumen-card">
        <h5 class="mb-3">Resumen de Compra</h5>
        
        <!-- Items del Carrito -->
        <div *ngFor="let item of carrito" class="resumen-item">
          <div>
            <h6>{{ item.nombre }}</h6>
            <small class="text-muted">Cantidad: {{ item.cantidad }}</small>
          </div>
          <div class="text-end">
            <strong>${{ formatearPrecio(item.precio * item.cantidad) }}</strong>
          </div>
        </div>

        <!-- Subtotal -->
        <div class="resumen-item">
          <span>Subtotal</span>
          <span>${{ formatearPrecio(getTotalPrecio()) }}</span>
        </div>

        <!-- Envío -->
        <div class="resumen-item" *ngIf="checkoutState.opcionEnvio">
          <span>Envío ({{ checkoutState.opcionEnvio.nombre }})</span>
          <span>${{ formatearPrecio(checkoutState.opcionEnvio.precio) }}</span>
        </div>

        <!-- Descuento -->
        <div class="resumen-item" *ngIf="checkoutState.cuponAplicado">
          <span>Descuento</span>
          <span class="text-success">
            -${{ formatearPrecio(checkoutState.cuponAplicado.descuento) }}
          </span>
        </div>

        <!-- Total -->
        <div class="resumen-item">
          <span>Total</span>
          <span>${{ formatearPrecio(getTotalConEnvio()) }}</span>
        </div>

        <!-- Botón de Confirmación -->
        <button class="btn btn-confirmar w-100 mt-4" 
                (click)="confirmarCompra()"
                [disabled]="!checkoutState.datosPersonales.nombre || !checkoutState.direccion.direccion">
          <i class="fas fa-credit-card me-2"></i>
          Confirmar Compra
        </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>